generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(cuid())
  email                String                @unique
  username             String                @unique
  password             String
  name                 String
  phone                String?
  role                 UserRole              @default(TECHNICIAN)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  activities           Activity[]
  expenses             Expense[]
  sessions             Session[]
  technicianProfile    Technician?           @relation("UserTechnician")
  maintenanceSchedules MaintenanceSchedule[] @relation("MaintenanceScheduleCreator")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  userAgent    String?
  ipAddress    String?
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Activity {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String?
  entityId  String?
  metadata  Json?
  ipAddress String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Company {
  id        String   @id @default(cuid())
  name      String
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id                   String                @id @default(cuid())
  name                 String
  companyName          String?
  phone                String
  email                String?
  address              String
  notes                String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  projects             Project[]
  quotations           Quotation[]
  maintenanceSchedules MaintenanceSchedule[]
}

model Project {
  id                         String                @id @default(cuid())
  projectNumber              String                @unique
  customerId                 String
  title                      String
  description                String?
  status                     ProjectStatus         @default(QUOTATION)
  budget                     Decimal               @db.Decimal(15, 2)
  actualCost                 Decimal               @default(0) @db.Decimal(15, 2)
  finalPrice                 Decimal?              @db.Decimal(15, 2)
  paymentTerms               Json?
  startDate                  DateTime?
  endDate                    DateTime?
  createdAt                  DateTime              @default(now())
  updatedAt                  DateTime              @updatedAt
  businessCashPercentage     Decimal?              @default(30) @db.Decimal(5, 2)
  generalExpenses            Expense[]
  financialSummary           FinancialSummary?
  payments                   Payment[]
  customer                   Customer              @relation(fields: [customerId], references: [id])
  expenses                   ProjectExpense[]
  items                      ProjectItem[]
  technicians                ProjectTechnician[]
  purchaseOrders             PurchaseOrder[]
  quotations                 Quotation[]
  technicianPayments         TechnicianPayment[]
  warranties                 Warranty[]
  maintenanceSchedules       MaintenanceSchedule[] @relation("MaintenanceSourceProject")
  resultMaintenanceSchedules MaintenanceSchedule[] @relation("MaintenanceResultProject")
}

model ProjectItem {
  id                 String              @id @default(cuid())
  projectId          String
  productId          String?
  name               String
  quantity           Int
  unit               String
  price              Decimal             @db.Decimal(15, 2)
  totalPrice         Decimal             @db.Decimal(15, 2)
  type               String
  addedAt            DateTime            @default(now())
  cost               Decimal             @default(0) @db.Decimal(15, 2)
  needsPo            Boolean             @default(false)
  poStatus           String              @default("NONE")
  returnedQty        Int                 @default(0)
  totalCost          Decimal             @default(0) @db.Decimal(15, 2)
  product            Product?            @relation(fields: [productId], references: [id])
  project            Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  purchaseOrderItems PurchaseOrderItem[]
}

model ProjectExpense {
  id          String   @id @default(cuid())
  projectId   String
  category    String
  description String
  amount      Decimal  @db.Decimal(15, 2)
  receipt     String?
  date        DateTime
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Quotation {
  id          String   @id @default(cuid())
  quotationNo String   @unique
  projectId   String?
  customerId  String
  title       String?
  items       Json
  totalAmount Decimal  @db.Decimal(15, 2)
  status      String   @default("DRAFT")
  validUntil  DateTime
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])
}

model Product {
  id                 String              @id @default(cuid())
  sku                String              @unique
  name               String
  category           String
  unit               String?
  purchasePrice      Decimal             @default(0) @db.Decimal(15, 2)
  sellingPrice       Decimal             @default(0) @db.Decimal(15, 2)
  minStock           Int                 @default(0)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  conversionFactor   Decimal             @default(1) @db.Decimal(15, 4)
  isService          Boolean             @default(false)
  purchaseUnit       String?
  serialNumbers      Json?               @default("[]")
  type               ProductType         @default(PRODUCT)
  projectItems       ProjectItem[]
  purchaseOrderItems PurchaseOrderItem[] @relation("POItemProduct")
  stock              Stock?
  stockMovements     StockMovement[]
  suppliers          SupplierProduct[]
  stockOpnames       StockOpname[]
}

model Stock {
  id          String          @id @default(cuid())
  productId   String          @unique
  quantity    Int             @default(0)
  reserved    Int             @default(0)
  available   Int             @default(0)
  lastUpdated DateTime        @updatedAt
  product     Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  movements   StockMovement[]
}

model StockMovement {
  id        String   @id @default(cuid())
  productId String
  stockId   String?
  type      String
  quantity  Int
  reference String?
  notes     String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  stock     Stock?   @relation(fields: [stockId], references: [id])
}

model StockOpname {
  id          String   @id @default(cuid())
  productId   String
  systemStock Int      @default(0)
  actualStock Int
  difference  Int
  notes       String?
  createdBy   String
  createdAt   DateTime @default(now())
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Supplier {
  id             String            @id @default(cuid())
  name           String
  contactPerson  String?
  phone          String
  email          String?
  address        String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  purchaseOrders PurchaseOrder[]
  products       SupplierProduct[]
}

model SupplierProduct {
  id         String   @id @default(cuid())
  supplierId String
  productId  String
  price      Decimal  @db.Decimal(15, 2)
  isActive   Boolean  @default(true)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productId])
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  poNumber     String              @unique
  projectId    String?
  supplierId   String
  totalAmount  Decimal             @db.Decimal(15, 2)
  status       String              @default("DRAFT")
  receivedDate DateTime?
  notes        String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  project      Project?            @relation(fields: [projectId], references: [id])
  supplier     Supplier            @relation(fields: [supplierId], references: [id])
  items        PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  projectItemId   String?
  productId       String?
  name            String
  quantity        Int
  price           Decimal       @db.Decimal(15, 2)
  total           Decimal       @db.Decimal(15, 2)
  receivedQty     Int           @default(0)
  product         Product?      @relation("POItemProduct", fields: [productId], references: [id])
  projectItem     ProjectItem?  @relation(fields: [projectItemId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model Technician {
  id              String              @id @default(cuid())
  userId          String?             @unique
  name            String
  phone           String
  type            String              @default("FREELANCE")
  feeType         String              @default("PERCENTAGE")
  feePercentage   Decimal?            @db.Decimal(5, 2)
  minFee          Decimal             @default(150000) @db.Decimal(15, 2)
  canViewProjects Boolean             @default(true)
  canViewEarnings Boolean             @default(true)
  canUpdateStatus Boolean             @default(false)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  assignments     ProjectTechnician[]
  user            User?               @relation("UserTechnician", fields: [userId], references: [id])
  payments        TechnicianPayment[]
}

model ProjectTechnician {
  id           String     @id @default(cuid())
  projectId    String
  technicianId String
  fee          Decimal    @db.Decimal(15, 2)
  feeType      String
  isPaid       Boolean    @default(false)
  paidDate     DateTime?
  notes        String?
  createdAt    DateTime   @default(now())
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  technician   Technician @relation(fields: [technicianId], references: [id])
}

model FinancialSummary {
  id            String   @id @default(cuid())
  projectId     String   @unique
  revenue       Decimal  @db.Decimal(15, 2)
  totalCost     Decimal  @db.Decimal(15, 2)
  grossMargin   Decimal  @db.Decimal(15, 2)
  marginPercent Decimal  @db.Decimal(5, 2)
  technicianFee Decimal  @db.Decimal(15, 2)
  companyFund   Decimal  @db.Decimal(15, 2)
  netProfit     Decimal  @db.Decimal(15, 2)
  calculated    DateTime @default(now())
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Payment {
  id            String      @id @default(cuid())
  projectId     String?
  amount        Decimal     @db.Decimal(15, 2)
  method        String
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  mode          PaymentMode @default(PROJECT)
  paymentDate   DateTime    @default(now())
  paymentNumber String      @unique
  receivedBy    String?
  reference     String?
  type          PaymentType
  project       Project?    @relation(fields: [projectId], references: [id])
}

model Warranty {
  id             String          @id @default(cuid())
  projectId      String
  startDate      DateTime
  endDate        DateTime
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  warrantyMonths Int             @default(12)
  warrantyNumber String          @unique
  status         WarrantyStatus  @default(ACTIVE)
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  claims         WarrantyClaim[]
}

model WarrantyClaim {
  id           String              @id @default(cuid())
  warrantyId   String
  claimNumber  String              @unique
  description  String
  reportedDate DateTime            @default(now())
  resolvedDate DateTime?
  resolution   String?
  status       WarrantyClaimStatus @default(PENDING)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  warranty     Warranty            @relation(fields: [warrantyId], references: [id], onDelete: Cascade)
}

model Expense {
  id            String      @id @default(cuid())
  type          ExpenseType @default(OPERATIONAL)
  category      String
  description   String
  amount        Decimal     @db.Decimal(15, 2)
  receipt       String?
  date          DateTime
  projectId     String?
  createdBy     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  createdByUser User        @relation(fields: [createdBy], references: [id])
  project       Project?    @relation(fields: [projectId], references: [id])
}

model Asset {
  id               String         @id @default(cuid())
  assetNumber      String         @unique
  name             String
  category         String
  description      String?
  purchaseDate     DateTime
  purchasePrice    Decimal        @db.Decimal(15, 2)
  currentValue     Decimal?       @db.Decimal(15, 2)
  serialNumber     String?
  location         String?
  condition        AssetCondition @default(GOOD)
  status           AssetStatus    @default(ACTIVE)
  depreciationRate Decimal?       @db.Decimal(5, 2)
  notes            String?
  photo            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model TechnicianPayment {
  id            String        @id @default(cuid())
  paymentNumber String        @unique
  technicianId  String
  projectId     String?
  period        String
  amount        Decimal       @db.Decimal(15, 2)
  description   String?
  status        PaymentStatus @default(PENDING)
  paidDate      DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  project       Project?      @relation(fields: [projectId], references: [id])
  technician    Technician    @relation(fields: [technicianId], references: [id])
}

model Unit {
  id          String           @id @default(cuid())
  name        String           @unique
  symbol      String
  description String?
  isBase      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  conversions UnitConversion[] @relation("FromUnit")
  convertedTo UnitConversion[] @relation("ToUnit")
}

model UnitConversion {
  id         String   @id @default(cuid())
  fromUnitId String
  toUnitId   String
  factor     Decimal  @db.Decimal(15, 4)
  notes      String?
  createdAt  DateTime @default(now())
  fromUnit   Unit     @relation("FromUnit", fields: [fromUnitId], references: [id], onDelete: Cascade)
  toUnit     Unit     @relation("ToUnit", fields: [toUnitId], references: [id], onDelete: Cascade)

  @@unique([fromUnitId, toUnitId])
}

enum UserRole {
  OWNER
  ADMIN
  TECHNICIAN
  VIEWER
}

enum ProductType {
  PRODUCT
  SERVICE
  MATERIAL
}

enum ProjectStatus {
  QUOTATION
  APPROVED
  PROCUREMENT
  ONGOING
  COMPLETED
  PAID
  CLOSED
}

enum PaymentMode {
  PROJECT
  POS
}

enum PaymentType {
  FULL
  DP
  INSTALLMENT
  SETTLEMENT
}

enum WarrantyStatus {
  ACTIVE
  EXPIRED
  CLAIMED
  VOIDED
}

enum WarrantyClaimStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum ExpenseType {
  PROJECT
  OPERATIONAL
  SALARY
  ASSET
}

enum AssetCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  BROKEN
}

enum AssetStatus {
  ACTIVE
  IDLE
  MAINTENANCE
  DISPOSED
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
}

model MaintenanceSchedule {
  id              String                    @id @default(cuid())
  projectId       String?
  customerId      String?
  resultProjectId String?
  title           String
  description     String?
  scheduledDate   DateTime
  completedDate   DateTime?
  status          MaintenanceScheduleStatus @default(SCHEDULED)
  notes           String?
  createdBy       String
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  project         Project?                  @relation("MaintenanceSourceProject", fields: [projectId], references: [id], onDelete: Cascade)
  customer        Customer?                 @relation(fields: [customerId], references: [id])
  resultProject   Project?                  @relation("MaintenanceResultProject", fields: [resultProjectId], references: [id])
  createdByUser   User                      @relation("MaintenanceScheduleCreator", fields: [createdBy], references: [id])
}

enum MaintenanceScheduleStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
